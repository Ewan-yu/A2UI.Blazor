@inherits A2UIComponentBase
@using A2UI.Core.Processing
@using A2UI.Core.Messages
@inject DataBindingResolver BindingResolver
@inject EventDispatcher EventDispatcher

<div class="@GetCssClass()" style="@GetInlineStyle()">
    @if (!string.IsNullOrEmpty(ResolvedLabel))
    {
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">@ResolvedLabel</label>
    }
    <div style="display: flex; flex-direction: column; gap: 8px;">
        @if (Options != null)
        {
            @foreach (var option in Options)
            {
                <label style="display: flex; align-items: center; cursor: pointer;">
                    @if (IsMultipleSelection)
                    {
                        <input type="checkbox" 
                               checked="@IsSelected(option.Id)" 
                               @onchange="@(e => HandleCheckboxChange(option.Id, e))"
                               style="margin-right: 8px;" />
                    }
                    else
                    {
                        <input type="radio" 
                               name="@Component.Id" 
                               checked="@IsSelected(option.Id)" 
                               @onchange="@(e => HandleRadioChange(option.Id))"
                               style="margin-right: 8px;" />
                    }
                    <span>@option.Label</span>
                </label>
            }
        }
    </div>
</div>

@code {
    private string? ResolvedLabel;
    private List<ChoiceOption> Options = new();
    private Dictionary<string, bool> SelectedStates = new();
    private bool IsMultipleSelection;

    private class ChoiceOption
    {
        public string Id { get; set; } = "";
        public string Label { get; set; } = "";
        public string? DataPath { get; set; }
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        // Get the question bound value
        var questionValue = GetDictionaryProperty("question");
        if (questionValue != null)
        {
            ResolvedLabel = BindingResolver.ResolveString(questionValue, SurfaceId, Component.DataContextPath);
        }

        // Get usage hint
        var usageHint = GetStringProperty("usageHint");
        IsMultipleSelection = usageHint?.ToLower() != "singleselection";

        // Get options
        if (Component.Properties.TryGetValue("options", out var optionsValue))
        {
            Options = ParseOptions(optionsValue);
        }
    }

    private List<ChoiceOption> ParseOptions(object optionsValue)
    {
        var result = new List<ChoiceOption>();
        SelectedStates.Clear();

        try
        {
            if (optionsValue is Dictionary<string, object> optionsDict &&
                optionsDict.TryGetValue("explicitList", out var listObj) &&
                listObj is List<object> objectList)
            {
                foreach (var item in objectList)
                {
                    if (item is Dictionary<string, object> dict)
                    {
                        var option = new ChoiceOption();
                        
                        if (dict.TryGetValue("id", out var idObj))
                        {
                            option.Id = idObj?.ToString() ?? "";
                        }
                        
                        if (dict.TryGetValue("label", out var labelObj))
                        {
                            var labelData = labelObj as Dictionary<string, object>;
                            option.Label = labelData != null ? 
                                BindingResolver.ResolveString(labelData, SurfaceId, Component.DataContextPath) ?? "" :
                                labelObj?.ToString() ?? "";
                        }
                        
                        if (dict.TryGetValue("selected", out var selectedObj))
                        {
                            var selectedData = selectedObj as Dictionary<string, object>;
                            if (selectedData != null && selectedData.TryGetValue("path", out var pathObj))
                            {
                                option.DataPath = pathObj?.ToString();
                                
                                // Get current selected state
                                var resolvedValue = BindingResolver.ResolveValue(selectedData, SurfaceId, Component.DataContextPath);
                                SelectedStates[option.Id] = resolvedValue is bool boolValue && boolValue;
                            }
                        }
                        
                        result.Add(option);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[A2UIMultipleChoice] Error parsing options: {ex.Message}");
        }

        return result;
    }

    private bool IsSelected(string optionId)
    {
        return SelectedStates.TryGetValue(optionId, out var selected) && selected;
    }

    private void HandleCheckboxChange(string optionId, ChangeEventArgs e)
    {
        if (e.Value is bool isChecked)
        {
            SelectedStates[optionId] = isChecked;
            
            var option = Options.FirstOrDefault(o => o.Id == optionId);
            if (option?.DataPath != null)
            {
                var dataUpdate = EventDispatcher.CreateDataUpdate(
                    SurfaceId,
                    Component.Id,
                    option.DataPath,
                    isChecked
                );
                EventDispatcher.DispatchDataUpdate(dataUpdate);
            }
            
            StateHasChanged();
        }
    }

    private void HandleRadioChange(string optionId)
    {
        // Uncheck all others
        foreach (var key in SelectedStates.Keys.ToList())
        {
            if (key != optionId)
            {
                SelectedStates[key] = false;
                var opt = Options.FirstOrDefault(o => o.Id == key);
                if (opt?.DataPath != null)
                {
                    var dataUpdate = EventDispatcher.CreateDataUpdate(
                        SurfaceId,
                        Component.Id,
                        opt.DataPath,
                        false
                    );
                    EventDispatcher.DispatchDataUpdate(dataUpdate);
                }
            }
        }
        
        // Check selected
        SelectedStates[optionId] = true;
        var option = Options.FirstOrDefault(o => o.Id == optionId);
        if (option?.DataPath != null)
        {
            var dataUpdate = EventDispatcher.CreateDataUpdate(
                SurfaceId,
                Component.Id,
                option.DataPath,
                true
            );
            EventDispatcher.DispatchDataUpdate(dataUpdate);
        }
        
        StateHasChanged();
    }

    protected override string GetCssClass()
    {
        return Theme.Components.MultipleChoice;
    }
}

