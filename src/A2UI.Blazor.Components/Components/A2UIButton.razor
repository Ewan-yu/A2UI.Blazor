@inherits A2UIComponentBase
@using A2UI.Core.Processing
@using A2UI.Core.Messages
@inject DataBindingResolver BindingResolver
@inject EventDispatcher EventDispatcher

<button class="@GetCssClass()" style="@GetInlineStyle()" @onclick="HandleClick">
    @if (!string.IsNullOrEmpty(ChildComponentId))
    {
        <A2UIRenderer SurfaceId="@SurfaceId" ComponentId="@ChildComponentId" DataContextPath="@Component.DataContextPath" />
    }
</button>

@code {
    private string? ChildComponentId;
    private Dictionary<string, object>? ActionData;
    private bool IsPrimary;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        ChildComponentId = GetStringProperty("child");
        ActionData = GetDictionaryProperty("action");
        IsPrimary = GetBoolProperty("primary", false);
    }

    private void HandleClick()
    {
        Console.WriteLine($"[A2UIButton] HandleClick: ComponentId={Component.Id}");
        
        if (ActionData == null)
        {
            Console.WriteLine($"[A2UIButton] ActionData is null, returning");
            return;
        }

        // Extract action name
        if (!ActionData.TryGetValue("name", out var nameObj) || nameObj is not string actionName)
        {
            Console.WriteLine($"[A2UIButton] No action name found, returning");
            return;
        }

        Console.WriteLine($"[A2UIButton] Action name: {actionName}");

        // Process updates if present (for data updates)
        if (ActionData.TryGetValue("updates", out var updatesObj) && updatesObj is List<object> updatesList)
        {
            Console.WriteLine($"[A2UIButton] Found {updatesList.Count} updates to process");
            
            foreach (var updateItem in updatesList)
            {
                if (updateItem is Dictionary<string, object> updateDict &&
                    updateDict.TryGetValue("path", out var pathObj) &&
                    pathObj is string path &&
                    updateDict.TryGetValue("value", out var value))
                {
                    Console.WriteLine($"[A2UIButton] Dispatching data update: path={path}, value={value}");
                    
                    var dataUpdate = EventDispatcher.CreateDataUpdate(
                        SurfaceId,
                        Component.Id,
                        path,
                        value
                    );
                    EventDispatcher.DispatchDataUpdate(dataUpdate);
                }
            }
        }
        else
        {
            Console.WriteLine($"[A2UIButton] No updates found in action");
        }

        // Resolve context
        Dictionary<string, object> context = new();
        if (ActionData.TryGetValue("context", out var contextObj) && 
            contextObj is List<Dictionary<string, object>> contextEntries)
        {
            context = BindingResolver.ResolveActionContext(contextEntries, SurfaceId, Component.DataContextPath);
        }

        // Create and dispatch user action
        Console.WriteLine($"[A2UIButton] Dispatching user action: {actionName}");
        var userAction = EventDispatcher.CreateUserAction(
            actionName,
            SurfaceId,
            Component.Id,
            context
        );

        EventDispatcher.DispatchUserAction(userAction);
    }

    protected override string GetCssClass()
    {
        var baseClass = Theme.Components.Button;
        var variantClass = IsPrimary ? Theme.Components.ButtonPrimary : Theme.Components.ButtonSecondary;
        return $"{baseClass} {variantClass}".Trim();
    }
}

