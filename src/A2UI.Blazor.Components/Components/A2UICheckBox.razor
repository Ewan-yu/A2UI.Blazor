@inherits A2UIComponentBase
@using A2UI.Core.Processing
@using A2UI.Core.Messages
@inject DataBindingResolver BindingResolver
@inject EventDispatcher EventDispatcher

<div class="@GetCssClass()" style="@GetInlineStyle()">
    <label style="display: flex; align-items: center; cursor: pointer;">
        <input type="checkbox" 
               checked="@IsChecked" 
               @onchange="HandleChange" 
               style="margin-right: 8px;" />
        <span>@ResolvedLabel</span>
    </label>
</div>

@code {
    private string? ResolvedLabel;
    private bool IsChecked;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        // Get the label bound value
        var labelValue = GetDictionaryProperty("label");
        if (labelValue != null)
        {
            ResolvedLabel = BindingResolver.ResolveString(labelValue, SurfaceId, Component.DataContextPath);
        }

        // Get the checked bound value (try both "checked" and "value" for compatibility)
        var checkedData = GetDictionaryProperty("checked") ?? GetDictionaryProperty("value");
        if (checkedData != null)
        {
            var resolvedValue = BindingResolver.ResolveValue(checkedData, SurfaceId, Component.DataContextPath);
            IsChecked = resolvedValue is bool boolValue && boolValue;
        }
    }

    private void HandleChange(ChangeEventArgs e)
    {
        if (e.Value is bool newValue)
        {
            IsChecked = newValue;

            // Dispatch data update event (try both "checked" and "value" for compatibility)
            var checkedData = GetDictionaryProperty("checked") ?? GetDictionaryProperty("value");
            if (checkedData != null && checkedData.TryGetValue("path", out var pathObj) && pathObj is string path)
            {
                var dataUpdate = EventDispatcher.CreateDataUpdate(
                    SurfaceId,
                    Component.Id,
                    path,
                    newValue
                );
                EventDispatcher.DispatchDataUpdate(dataUpdate);
            }
        }
    }

    protected override string GetCssClass()
    {
        return Theme.Components.CheckBox;
    }
}

